@model IEnumerable<DAL.Models.Appointment>

@{
    ViewData["Title"] = "Index";
}
<div class="container mt-3">
    <h2>Gestión de Citas</h2>
    <p>Apartado donde se gestionan las citas de TodoFrenos</p>
    <div class="container-border-custom mb-2">
        <div class="table-responsive">
            <div id="dataTable_wrapper" class="dataTables_wrapper">
                <div class="col-sm-12">
                    <h3>Citas</h3>
                    <table id="appointmentTable" class="table table-bordered dataTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="th-bg-custom">Email</th>
                                <th class="th-bg-custom">Fecha de Cita</th>
                                <th class="th-bg-custom">Motivo</th>
                                <th class="th-bg-custom">Estado</th>
                                <th class="th-bg-custom action-column-header">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var appointment in Model)
                            {
                                <tr id="appointment-@appointment.AppointId" class="appointment-row @(appointment.AppointState == 0 ? "has-actions" : "")">
                                    <td>@appointment.User?.Email</td>
                                    <td>@appointment.AppointCreationDate?.ToString("dd/MM/yyyy")</td>
                                    <td>@appointment.Reason</td>
                                    <td class="text-center align-middle">
                                        @{
                                            string estado = appointment.AppointState == 0 ? "Pendiente" :
                                            appointment.AppointState == 1 ? "Aceptado" :
                                            "Rechazado";
                                        }
                                        @estado
                                    </td>
                                    <td class="text-center align-middle action-column">
                                        @if (appointment.AppointState == 0)
                                        {
                                            <form id="acceptForm-@appointment.AppointId" asp-action="AcceptAppointment" method="post">
                                                <input type="hidden" name="id" value="@appointment.AppointId" />
                                                <button type="submit" class="btn btn-success accept-btn" data-id="@appointment.AppointId">Aceptar</button>
                                            </form>
                                            <form id="rejectForm-@appointment.AppointId" asp-action="RejectAppointment" method="post">
                                                <input type="hidden" name="id" value="@appointment.AppointId" />
                                                <button type="submit" class="btn btn-danger reject-btn" data-id="@appointment.AppointId">Rechazar</button>
                                            </form>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Inicialización de DataTable
        var table = $('#appointmentTable').DataTable({
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
            },
            "info": false,
            "columnDefs": [
                { "orderable": false, "targets": [4] } // Deshabilitar ordenación en la columna de acciones
            ]
        });

        // Mostrar u ocultar la columna de acciones según sea necesario
        var actionColumnVisible = $('#appointmentTable tbody tr.has-actions').length > 0;
        table.column('.action-column-header').visible(actionColumnVisible);

        // Manejo de acciones de aceptar y rechazar citas
        $(document).on('click', '.accept-btn', function (e) {
            e.preventDefault();
            var form = $(this).closest('form');
            var row = form.closest('tr');
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    row.find('.action-column').fadeOut();
                    // Recargar la página para actualizar la tabla
                    location.reload();
                },
                error: function () {
                    alert('Hubo un error al aceptar la cita.');
                }
            });
        });

        $(document).on('click', '.reject-btn', function (e) {
            e.preventDefault();
            var form = $(this).closest('form');
            var row = form.closest('tr');
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    row.find('.action-column').fadeOut();
                    // Recargar la página para actualizar la tabla
                    location.reload();
                },
                error: function () {
                    alert('Hubo un error al rechazar la cita.');
                }
            });
        });
    });
</script>
