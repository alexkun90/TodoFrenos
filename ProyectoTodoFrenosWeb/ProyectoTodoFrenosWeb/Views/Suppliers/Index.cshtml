@model IEnumerable<DAL.Models.Suppliers>

<h2>Gestión de Proveedores</h2>

<div class="container mt-3">
    <h2>Gestión de Citas</h2>
    <p>Apartado donde se gestionan las citas de TodoFrenos</p>
    <div class="container-border-custom mb-2">
        <div class="table-responsive">
            <div id="dataTable_wrapper" class="dataTables_wrapper">
                <div class="col-sm-12">
                    <h3>Citas</h3>
                    <table id="supplierTable" class="table table-bordered dataTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="th-bg-custom">Email</th>
                                <th class="th-bg-custom">Fecha de Registro</th>
                                <th class="th-bg-custom">Motivo</th>
                                <th class="th-bg-custom">Estado</th>
                                <th class="th-bg-custom action-column-header">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var supplier in Model)
                            {
                                <tr id="supplier-@supplier.SupplierId" class="appointment-row @(supplier.SupplierState == 0 ? "has-actions" : "")">
                                    <td>@supplier.Email</td>
                                    <td>@supplier.SupplierCreationDate?.ToString("dd/MM/yyyy")</td>
                                    <td>@supplier.Cause</td>
                                    <td class="text-center align-middle">
                                        @{
                                            string estado = supplier.SupplierState == 0 ? "Pendiente" :
                                            supplier.SupplierState == 1 ? "Aceptado" :
                                            "Rechazado";
                                        }
                                        @estado
                                    </td>
                                    <td class="text-center align-middle action-column">
                                        @if (supplier.SupplierState == 0)
                                        {
                                            <form id="acceptForm-@supplier.SupplierId" asp-action="SupplierAppointment" method="post">
                                                <input type="hidden" name="id" value="@supplier.SupplierId" />
                                                <button type="submit" class="btn btn-success accept-btn" data-id="@supplier.SupplierId">Aceptar</button>
                                            </form>
                                            <form id="rejectForm-@supplier.SupplierId" asp-action="RejectSupplier" method="post">
                                                <input type="hidden" name="id" value="@supplier.SupplierId" />
                                                <button type="submit" class="btn btn-danger reject-btn" data-id="@supplier.SupplierId">Rechazar</button>
                                            </form>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        
        var table = $('#supplierTable').DataTable({
            "language": {
                "url": "https://cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
            },
            "info": false,
            "columnDefs": [
                { "orderable": false, "targets": [4] } 
            ]
        });

        
        var actionColumnVisible = $('#supplierTable tbody tr.has-actions').length > 0;
        table.column('.action-column-header').visible(actionColumnVisible);

        
        $(document).on('click', '.accept-btn', function (e) {
            e.preventDefault();
            var form = $(this).closest('form');
            var row = form.closest('tr');
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    row.find('.action-column').fadeOut();
                    
                    location.reload();
                },
                error: function () {
                    alert('Hubo un error al aceptar la cita.');
                }
            });
        });

        $(document).on('click', '.reject-btn', function (e) {
            e.preventDefault();
            var form = $(this).closest('form');
            var row = form.closest('tr');
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function (response) {
                    row.find('.action-column').fadeOut();
                    
                    location.reload();
                },
                error: function () {
                    alert('Hubo un error al rechazar la cita.');
                }
            });
        });
    });
</script>